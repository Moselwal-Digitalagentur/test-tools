spec:
  inputs:
    stage:
      default: 'test'
---
test:site:phpmetrics:
  stage: $[[ inputs.stage ]]
  image: registry.moselwal.io/devops/images/php/$PHP_VERSION/ci/php-ci
  rules:
    - if: $CI_DEPLOY_FREEZE == null && $CI_COMMIT_REF_NAME == $CI_DEFAULT_BRANCH && $CI_PIPELINE_SOURCE != "schedule"
    - if: $CI_PIPELINE_SOURCE == "schedule"
      when: never
  allow_failure: true
  tags:
    - docker
  before_script:
    - composer req phpmetrics/phpmetrics
  script:
    - php vendor/bin/phpmetrics --report-summary-json=phpmetrics/summary.json --report-csv=phpmetrics/report.csv --report-html=phpmetrics/html-report/   --report-violations=phpmetrics/violations.xml --git --config=phpmetrics/config.json .
  needs: [ "build:site:test:backend" ]
  artifacts:
    when: always
    expire_in: 1 day
    paths:
      - /phpmetrics/*
